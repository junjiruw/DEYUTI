<!DOCTYPE html>
<html lang="ja">
    <head prefix="og: http://ogp.me/ns# website: http://ogp.me/ns/website#">
        <meta charset="UTF-8">
        <!--文字コードは上のほうにないとすべておしまいになるらしい-->
        <meta name="description" content="ブラウザで3Dモデル表示してみたい。">                                                                 <!--ページ説明　入力すること！-->
        <title>JUN汁ｗおもちゃばこ。/おもちゃ/3Dモデル表示したい</title>                                                         <!--タイトル　入力すること！-->
        <!--OGPとかいうの-->
        <meta property="og:site_name" content="JUN汁ｗおもちゃばこ。/omocha/3Dmodel_hyouji">                                <!--タイトル　入力すること！-->
        <meta property="og:title" content="3Dモデル表示したい">                                                               <!--タイトル　入力すること！-->
        <meta property="og:type" content="article"> <!--websiteはトップページ、articleが記事だってさ-->
        <meta property="og:url" content="https://junjiruw.github.io/DEYUTI/omocha/3Dmodel_hyouji.html">                   <!--リンク　入力すること！-->
        <meta property="og:image" content="https://github.com/junjiruw/DEYUTI/blob/master/images/site/junjiruw_bako.png?raw=true">
        <meta name="twitter:card" content="summary"><!--なにを表示するか-->
        <meta name="twitter:site" content="@junjiruw"><!--フッターに表示されるらしい…どこ？-->
        <meta name="viewport" content="width=device-width,initial-scale=1"><!--スマホで見てる人向けに表示領域の設定-->
        <link rel="stylesheet" href="../css/style.css">
        
        <link rel="icon" href="../images/site/favicon32.png">
        <style>
            
            div#parent_div{
                text-align: center;
                margin: 10px;
                position: relative;/*子要素のabsoluteの原点をここにする*/
            }
            canvas{
                border: 1px solid #FFF;
            }
            canvas#cnvs{
                /*表示大きさはThree.jsで設定*/
                position: absolute;
            }
            input{
                -webkit-appearance: auto;/*デフォルトデザインのボタン殺してたんだったぜ！*/
            }
        </style>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-1MB5XLN4LW"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-1MB5XLN4LW');
        </script>
        <!-- Google tag (gtag.js) -->

        <!--Three.jsのインポート用。最新バージョンはここをチェック：https://www.npmjs.com/package/three?activeTab=versions-->
        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
                    "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
                }
            }
        </script>
        <!--Three.jsのインポート用 examples/jsm/は外部ファイルローダーがたっぷりいる-->

        <script src="../js/public.js"></script>

        <script type="module">
            import * as THREE from "three";//インポート。type="module"じゃないと使えないらしいっス！
            import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";//GLTF形式のロードに使うッス！
            // GLTF・GLB形式のモデルデータを読み込むための…アレさ！
            const loader = new GLTFLoader();
            
            onload = async function(){
                onload_functions();
                const cnvs = document.getElementById('cnvs');//IDを指定して変数にぶち込む
                const cnvs_3D = document.getElementById('cnvs_3D');//IDを指定して変数にぶち込む

                const renderer = new THREE.WebGLRenderer({//ここに表示、よろしく！
                    canvas: cnvs_3D
                });

                function Resize_cnvs(){
                    if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {//貴様！スマホで見ているな！？
                        cnvs.style.width=cnvs.parentElement.clientWidth+"px";
                        renderer.setSize(cnvs.parentElement.clientWidth,cnvs.parentElement.clientWidth);
                    }else{//PCかな…
                        cnvs.style.width=window.innerHeight*0.7+"px";
                        renderer.setSize(window.innerHeight*0.7, window.innerHeight*0.7);
                    }
                    cnvs.style.height=cnvs.clientWidth+"px";
                }
                Resize_cnvs();//キャンバスサイズ設定してねー☆
                window.addEventListener('resize', Resize_cnvs);//キャンバスサイズ変更されたらもっかいね
                
                const scene = new THREE.Scene();                

                const 操作画像_1 = new Image();
                const 操作画像_2 = new Image();
                const 操作画像_3 = new Image();
                const 操作画像_4 = new Image();
                操作画像_1.src="../images/omocha/3Dmodel_hyouji/sousaaikon_1.png";
                操作画像_2.src="../images/omocha/3Dmodel_hyouji/sousaaikon_2.png";
                操作画像_3.src="../images/omocha/3Dmodel_hyouji/sousaaikon_3.png";
                操作画像_4.src="../images/omocha/3Dmodel_hyouji/sousaaikon_4.png";

                const 刹那 = new THREE.Clock();
                let 倍速=1;

                let クリック中 = false;
                let タップ開始=0;
                let 開始x=0, 開始y=0;
                let 開始指距離=0;
                let ドラッグ移動x = 0, ドラッグ移動y = 0, ホイール移動=0;

                cnvs.addEventListener("mousedown", (e) => {
                    クリック中 = true;
                    開始x = e.clientX;
                    開始y = e.clientY;
                });

                document.addEventListener("touchstart", (e) => {
                    //クリック中 = true; //いらないんじゃない？
                    
                    if(e.touches.length == 2){//指が二本ある～～～
                        e.preventDefault(); // ブラウザのデフォルトのズーム動作を無効化する
                        開始指距離=Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)**2+(e.touches[0].clientY-e.touches[1].clientY)**2);
                    }else if(e.touches.length == 1){
                        //拡大操作したときに暴発するのでちょっとガードする
                        タップ開始=0;
                        //開始x = e.touches[0].clientX;
                        //開始y = e.touches[0].clientY;
                    }
                    
                });

                document.addEventListener("mouseup", () => {
                    クリック中= false;
                    ドラッグ移動x = 0;
                    ドラッグ移動y = 0;
                });
                document.addEventListener("mouseleave", () => {
                    クリック中= false;
                    ドラッグ移動x = 0;
                    ドラッグ移動y = 0;
                });

                document.addEventListener("touchend", () => {
                    //クリック中= false; //いらないんじゃない？
                    タップ開始=0;
                    ドラッグ移動x = 0;
                    ドラッグ移動y = 0;
                }, { passive: false });//デフォルト操作を妨害するときのオプション？

                

                document.addEventListener("mousemove", (e) => {
                    if(クリック中){
                        ドラッグ移動x=e.clientX-開始x;
                        ドラッグ移動y=-e.clientY+開始y;

                        開始x = e.clientX;
                        開始y = e.clientY;
                    }
                });

                document.addEventListener("touchmove", (e) => {
                    if(e.touches.length == 2){//指が二本ある～～～
                        e.preventDefault(); // ブラウザのデフォルトのズーム動作を無効化する

                        ホイール移動=-1*(Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)**2+(e.touches[0].clientY-e.touches[1].clientY)**2)-開始指距離);
                        開始指距離=Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)**2+(e.touches[0].clientY-e.touches[1].clientY)**2);
                    }else if(e.touches.length == 1){
                        e.preventDefault(); // ブラウザのデフォルトのズーム動作を無効化する
                        //console.log(開始x);
                        
                        //拡大操作したときに暴発するのでちょっとガードする
                        タップ開始++;
                        if(タップ開始==3){
                            開始x = e.touches[0].clientX;
                            開始y = e.touches[0].clientY;
                        }else if(タップ開始>3){
                            ドラッグ移動x=(e.touches[0].clientX-開始x)*2;
                            ドラッグ移動y=(-e.touches[0].clientY+開始y)*2;

                            開始x = e.touches[0].clientX;
                            開始y = e.touches[0].clientY;
                        }
                        
                    
                    }
                    
                }, { passive: false });//デフォルト操作を妨害するときのオプション？

                cnvs.addEventListener("wheel", (e) => {
                    ホイール移動=e.deltaY;//-100 or 0 or 100
                });




                //カメラ
                const camera = new THREE.PerspectiveCamera(90, 1);// 画角, アスペクト比
                camera.position.set(0, 3, -5);
                camera.lookAt(new THREE.Vector3(0, 3, 0));

                // しゅうくんだ！
                const glb = await loader.loadAsync('../3D/omocha/3Dmodel_hyouji/LOW_SYUUKUN.glb');
                const SYUUKUN = glb.scene;
                SYUUKUN.position.set(0, 0, 0);
                scene.add(SYUUKUN);        
                
                const syuukun_anim= glb.animations;//アニメーション
                const syuukun_mixer = new THREE.AnimationMixer(SYUUKUN);//アニメーションミキサー
                var アクション={};
                for (let i = 0; i < syuukun_anim.length; i++) {        
                    アクション[i] = syuukun_mixer.clipAction(syuukun_anim[i]) ;
                    アクション[i].setLoop(THREE.LoopRepeat);//無限ルーピ        
                    console.log(syuukun_anim[i].name);
                }
                const slider = document.getElementById('slider');
                const slider値 = document.getElementById('slider値');
                slider.addEventListener('input', function() {
                    倍速 = (this.value/2)**2;
                    slider値.textContent = 倍速;
                });

                const チェック1 = document.getElementById('check_1');
                const チェック2 = document.getElementById('check_2');
                const チェック3 = document.getElementById('check_3');

                アクション[0].play();//デフォでうごかしとこ
                チェック1.addEventListener('change', function() {
                    if (this.checked) {
                        アクション[0].play();
                    } else {
                        アクション[0].stop();
                    }
                });

                チェック2.addEventListener('change', function() {
                    if (this.checked) {
                        アクション[1].play();
                    } else {
                        アクション[1].stop();
                    }
                });

                チェック3.addEventListener('change', function() {
                    if (this.checked) {
                        アクション[2].play();
                    } else {
                        アクション[2].stop();
                    }
                });

                //環境光
                const light = new THREE.AmbientLight(0xFFFFFF, 0.1);
                scene.add(light);

                // 平行光源
                const directionalLight = new THREE.DirectionalLight(0xFFFFFF);
                directionalLight.position.set(1, 1, -1);
                scene.add(directionalLight);

                
                var ctx = cnvs.getContext("2d");
                ctx.font = "30px 'ＭＳ Ｐゴシック'";//フォント設定。左のフォントがないと右のフォントを適用するらしい。
                ctx.fillStyle="#FFFFFF";

                Main();//ループ関数
                function Main() {
                    ctx.clearRect(0, 0, cnvs.width, cnvs.height);//更新！
                    
                    ///SYUUKUN.rotation.y += 0.01;

                    //まずは上下左右ぐりぐり
                    ドラッグ移動x*=0.01;
                    ドラッグ移動y*=-0.01;

                    let now_x=camera.position.x;
                    let now_y=camera.position.y-3;
                    let now_z=camera.position.z;

                    camera.position.x = 1 *now_x*Math.cos(ドラッグ移動x )- 1*now_z*Math.sin(ドラッグ移動x );
                    camera.position.z = 1 *now_x*Math.sin(ドラッグ移動x )+ 1*now_z*Math.cos(ドラッグ移動x );
                    
                    now_x=camera.position.x;
                    now_y=camera.position.y-3;
                    now_z=camera.position.z;

                    let xz_kyori=Math.sqrt(now_x*now_x+now_z*now_z);

                    let next_x=-1 *now_x/xz_kyori*now_y*Math.sin(ドラッグ移動y )+ 1*now_x*Math.cos(ドラッグ移動y );
                    let next_y= 1 *now_y*Math.cos(ドラッグ移動y )+ 1*xz_kyori*Math.sin(ドラッグ移動y )+3;
                    let next_z=-1 *now_z/xz_kyori*now_y*Math.sin(ドラッグ移動y )+ 1*now_z*Math.cos(ドラッグ移動y );
                    //console.log("k"+xz_kyori);
                    if(now_x*next_x<0 && now_z*next_z<0){
                        //真上、真下で操作が逝くので制限。
                        //更新しないでおいて
                    }else{
                        camera.position.x = next_x;
                        camera.position.y = next_y;
                        camera.position.z = next_z;
                        
                    }
                    
                    //拡大縮小
                    let camera_length=Math.sqrt(camera.position.x*camera.position.x +(camera.position.y-3)*(camera.position.y-3) +camera.position.z*camera.position.z)
                    if(camera_length<4){//近いなら小さく動く
                        camera.position.x *= (camera_length+(ホイール移動)/500)/camera_length;
                        camera.position.y = (camera.position.y-3)*(camera_length+(ホイール移動)/500)/camera_length+3;
                        camera.position.z *= (camera_length+(ホイール移動)/500)/camera_length;
                    }else{//遠いなら大きく動く                 
                        camera.position.x *= (camera_length+(ホイール移動)/100)/camera_length;
                        camera.position.y =(camera.position.y-3)*(camera_length+(ホイール移動)/100)/camera_length+3;
                        camera.position.z *= (camera_length+(ホイール移動)/100)/camera_length;
                    }
                    ホイール移動=0;
                    
                    
                    ctx.fillText("操作方法は…上のコレの通りだ！", 15, 130);
                    ctx.drawImage(操作画像_1, 0, 0);
                    ctx.drawImage(操作画像_2, 130, 0);
                    ctx.drawImage(操作画像_3, 300, 0);
                    ctx.drawImage(操作画像_4, 430, 0);

                    camera.lookAt(new THREE.Vector3(0, 3, 0));
                    ドラッグ移動x = 0;
                    ドラッグ移動y = 0;

                    syuukun_mixer.update(刹那.getDelta()*倍速);//ちょっと動けー！
                    renderer.render(scene, camera); // レンダリング
                    requestAnimationFrame(Main);// 次フレームも実行よろしく！
                }
            }
        </script>
    </head>
    <body>
        <div id="top"></div>
        <header id="header">
            <button onclick="html_link_btn()" id="html_link_btn"></button>
            <nav id="html_link_nav">
                <ul id="html_link_ul"></ul>
            </nav>
            <a href="../index.html">
                <img id="go_home" src="../images/site/omotyabako_deka.png" alt="トップページへ" height="1px"><!--ここで高さを入れておかないと、クソでかい画像が一瞬読み込まれてボタンの大きさが暴走する-->
            </a>
            <h1 id="title_h1">
                JUN汁ｗおもちゃばこ。
            </h1>
        </header>
        <div id="mannaka">

            ぐりぐりうごかせるかも、しれませんよ？
            <div id="parent_div">
                <canvas id="cnvs" height="1000px" width="1000px"><!--実大きさはThree.jsで決めてる-->
                </canvas>
                <canvas id="cnvs_3D"><!--実大きさはThree.jsで決めてる-->
                </canvas>
            </div>

            <input type="checkbox" id="check_1" checked> ポカポカ
            <input type="checkbox" id="check_2" > うずうず待機
            <input type="checkbox" id="check_3" > 歩き
            <input type="range" min="0" max="10" value="2" id="slider"> 速度 <span id="slider値">1</span> 倍

            <footer>
                <ul id="footul">
                    <li id="foot_tweet_li">
                        <a href=""  target="_blank" rel="noopener noreferrer" id="foot_tweet_a"><!--onload_functions()でhrefを書き込んでるで！-->
                            <img src="../images/site/twitterbutton.gif" alt="ツイートボタン" id="tweet_img">
                        </a>
                    </li>
                    <li>
                        <a href="#top" id="totop"> 
                            ページ上部に移動
                        </a>
                    </li>
                </ul>
            </footer>
        </div>
    </body>
</html>
